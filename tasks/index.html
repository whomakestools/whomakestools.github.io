<!doctype html>
<html ng-app="prjMngProjetos">

<head>
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


    <!-- <script src="angular.js"></script> -->

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-sanitize.min.js"></script>

    <script src="FileServe.js"></script>

    <script>
        function salvar(nome, conteudo) {
            let blob = new Blob([conteudo], { type: "text/plain;charset=utf-8" });
            saveAs(blob, nome + ".html");
        }

        function generateUUID() { // Public Domain/MIT
            var d = new Date().getTime();//Timestamp
            var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now() * 1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16;//random number between 0 and 16
                if (d > 0) {//Use timestamp until depleted
                    r = (d + r) % 16 | 0;
                    d = Math.floor(d / 16);
                } else {//Use microseconds since page-load if supported
                    r = (d2 + r) % 16 | 0;
                    d2 = Math.floor(d2 / 16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
    </script>

    <style>
        .displayTime {
            text-align: center;
            border: 1px solid;
            padding: 5px;
        }

        .zero {

            animation: example 1s infinite;
        }

        @keyframes example {
            from {
                /* background-color: red; */
                /* color: red; */

            }

            to {
                /* color: black; */
                box-shadow: 1px 1px 10px silver;

            }
        }

        .pontos {
            font-weight: 600;
            font-size: x-large;
        }

        .dPrj {
            width: 100%;
            height: 100%;
            top: 0;
            border: none;
            background: silver;
            text-align: center;
        }

        .mPrj {
            display: inline-table;
            border: 1px solid;
            background: white;
            text-align: left;
            padding: 15px;
        }

        pre {
            padding: 9.5px;
            margin: 0 0 10px;
            font-size: large;
            font-family: inherit;
            /* line-height: 1.42857143; */
            /* color: #333; */
            /* word-break: break-all; */
            /* word-wrap: break-word; */
            background-color: #f5f5f5;
            border: 1px solid #ccc;
        }

        * {
            font-size: medium;
            align-items: baseline;
        }

        .titTarefas {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            font-weight: bolder;

        }

        table tr:not(:first-child):hover {
            background-color: #f5f5f5;
            color: crimson;
        }

        tr {
            cursor: default;

        }

        /* tr:hover {
            background-color: #f5f5f5;
            border-bottom: 1px solid;
        } */

        table {
            border: 1px solid;
        }

        .principall {
            width: 80%;
            margin: 0 auto;
        }

        .projeto {
            margin: 15px;
            border: 1px solid;
            padding: 5px;
        }

        label {
            cursor: pointer;
        }

        ul {
            list-style: none;
            display: inline;
        }

        .pos {
            border: 1px solid;
            padding: 5px;
        }

        .linha {
            width: 100%;
            padding: 5px;
            display: inline-grid;
        }

        pre {
            font-family: auto;
        }

        .glyphicon {
            margin: 10px;
            cursor: pointer;
        }

        .glyphicon:hover {
            box-shadow: rgb(190, 151, 77) 1px 1px 2px;
        }

        .linha2 {
            display: flex;
            justify-content: center;
        }

        .inpt {
            width: 25%;
            margin: 0px 5px;
        }

        li {
            margin-left: 20px;
        }
    </style>

</head>

<body>

    <h2>Projetos</h2>
    <div ng-controller="listProjetosController" class="principal">
        <button id="btnNovoPrj" ng-click="abrirDiaolgProjeto()" class="btn btn-primary">Novo Projeto</button>
        <ul class="projetos">
            <li ng-repeat="projeto in projetos track by $index" class="projeto">
                <i ng-class="{'glyphicon-folder-open': projeto.visible, 'zero': primeiroPrj(projeto)===false && projeto.visible===false} "
                    ng-click="projeto.visible=!projeto.visible; projeto.pos.visible=false; projeto.tasks.visible=false;"
                    class="glyphicon glyphicon-folder-close"></i>
                <label>projeto - {{projeto.nome}} </label>
                <i title="Editar" ng-click="abrirDiaolgProjeto(projeto)" class="glyphicon glyphicon-edit"></i>
                <i title="Exportar" ng-click="exportarProjeto(projeto)" class="glyphicon glyphicon-share"></i>
                <i title="Excluir" class="glyphicon glyphicon-trash" ng-click="deleteProjeto(projeto)"></i>
                <ul ng-show="projeto.visible">
                    <li class="lii">
                        <pre>{{projeto.descricao}}</pre>
                    </li>
                    <li>
                        <i ng-class="{'glyphicon-folder-open': projeto.pos.visible}"
                            ng-click="projeto.pos.visible=!projeto.pos.visible" class="glyphicon glyphicon-folder-close"
                            alt="Expandir"></i>
                        <label> Envolvidos ({{projeto.pos.length}})</label>
                        <i class="glyphicon glyphicon-plus" ng-click="abrirDiaolgPo(projeto)"></i>
                        <table ng-show="projeto.pos.visible && projeto.visible"
                            style="width: 100%; display: inline-table;">
                            <tr>
                                <th></th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                            </tr>
                            <tr ng-repeat="po in projeto.pos track by $index">
                                <td width="10%" style="text-align: center;">
                                    <i ng-click="abrirDiaolgPo(projeto,po)" class="glyphicon glyphicon-edit"></i>
                                    <i class="glyphicon glyphicon-trash"
                                        ng-click="deletePo(projeto,po);projeto.pos.visible=true"></i>
                                </td>
                                <td width="50%">{{po.nome}}</td>
                                <td>{{po.email}}</td>
                                <td>{{po.telefone}}</td>
                            </tr>
                        </table>
                    </li>
                    <li>
                        <i ng-class="{'glyphicon-folder-open': projeto.tasks.visible }"
                            ng-click="projeto.tasks.visible=!projeto.tasks.visible;projeto.tasks.atividades.visible=false;projeto.tasks.apontamentos.visible=false;"
                            class="glyphicon glyphicon-folder-close"></i>
                        <label>Tarefas({{projeto.tasks.length}}) - Estimado: {{estimativaGeral(projeto)}} ,
                            Apontamentos: {{apontamentosGeral(projeto)}} - Total Real {{restanteGeral(projeto)}}</label>
                        <i class="glyphicon glyphicon-plus" ng-click="abrirDiaolgTask(projeto)"></i>
                        <ul ng-show="projeto.tasks.visible && projeto.visible">
                            <li ng-repeat="tarefa in projeto.tasks track by $index"
                                style="border: 1px solid;margin-bottom:5px">
                                <i ng-class="{'glyphicon-folder-open': tarefa.visible}"
                                    ng-click="tarefa.visible=!tarefa.visible; tarefa.atividades.visible=false;tarefa.apontamentos.visible=false;"
                                    class="glyphicon glyphicon-folder-close"></i>
                                <label style="width: 30%;">Tarefa: {{tarefa.descricao}}</label>
                                <label>Estimado: {{estimativaTarefa(tarefa)}}</label>
                                <label>Apontamentos: {{apontamentosTarefa(tarefa)}}</label>
                                <label>Concluído: {{tarefa.apontamentos.slice(-1)[0].percentual}}%</label>
                                <label>Real esperado: {{restanteTarefa(tarefa)}}</label>
                                <i class="glyphicon glyphicon-edit" ng-click="abrirDiaolgTask(projeto,tarefa)"></i>
                                <i class="glyphicon glyphicon-trash"
                                    ng-click="deleteTask(projeto,tarefa);projeto.tasks.visible=true;"></i>
                                <ul ng-show="tarefa.visible && projeto.tasks.visible">
                                    <li>
                                        <i ng-class="{'glyphicon-folder-open': tarefa.atividades.visible}"
                                            class="glyphicon glyphicon-folder-close"
                                            ng-click="tarefa.atividades.visible=!tarefa.atividades.visible"></i>
                                        <label>Atividades({{tarefa.atividades.length}}) | Estimado:
                                            {{estimativaTarefa(tarefa)}} </label>
                                        <i class="glyphicon glyphicon-plus" ng-click="abrirDialogAtividade(tarefa)"></i>

                                        <table ng-show="tarefa.atividades.visible  && tarefa.visible"
                                            style="width: 100%; display: inline-table;">
                                            <tr>
                                                <th></th>
                                                <th>Descrição</th>
                                                <th>Estimativa</th>
                                            </tr>
                                            <tr ng-repeat="atividade in tarefa.atividades track by $index">
                                                <td style="width: 10%; text-align: center;">
                                                    <i ng-click="abrirDialogAtividade(tarefa,atividade);tarefa.atividades.visible=true;"
                                                        class="glyphicon glyphicon-edit"></i>
                                                    <i ng-click="deleteAtividade(tarefa,atividade);tarefa.atividades.visible=true;"
                                                        class="glyphicon glyphicon-trash"></i>
                                                </td>
                                                <td>{{atividade.descricao}}</td>
                                                <td>{{atividade.hora | zpad:2}}:{{atividade.minuto | zpad:2}}</td>
                                            </tr>
                                        </table>
                                    </li>
                                    <li>
                                        <i ng-class="{'glyphicon-folder-open': tarefa.apontamentos.visible}"
                                            class="glyphicon glyphicon-folder-close"
                                            ng-click="tarefa.apontamentos.visible=!tarefa.apontamentos.visible"></i>
                                        <label>Apontamentos({{tarefa.apontamentos.length}}) | Total:
                                            {{apontamentosTarefa(tarefa)}} </label>
                                        <i class="glyphicon glyphicon-plus"
                                            ng-click="abrirDialogApontamento(tarefa);tarefa.apontamentos.visible=true;"></i>
                                        <table ng-show="tarefa.apontamentos.visible  && tarefa.visible"
                                            style="width: 100%; display: inline-table;">
                                            <tr>
                                                <th></th>
                                                <th>Data</th>
                                                <th>Tempo</th>
                                                <th>Percentual atual da tarefa</th>
                                            </tr>
                                            <tr
                                                ng-repeat="apontamento in tarefa.apontamentos| orderBy: '-data' track by $index">
                                                <td style="width: 10%; text-align: center;">
                                                    <i class="glyphicon glyphicon-trash"
                                                        ng-click="deleteApontamento(tarefa,apontamento);tarefa.apontamentos.visible=true;"></i>
                                                </td>
                                                <td>{{apontamento.data }}</td>
                                                <td>{{apontamento.hora | zpad:2}}:{{apontamento.minuto | zpad:2}}</td>
                                                <td>{{apontamento.percentual}}%</td>
                                            </tr>
                                        </table>
                                    </li>
                                </ul>

                            </li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
        <!-- mProjeto -->
        <dialog id="dProjeto" class="dPrj">
            <div class="mPrj">
                <div class="linha">
                    <H1>Projeto</H1>
                </div>
                <div class="linha">
                    <label>Nome projeto</label>
                    <input maxlength="30" ng-model="projetoEditar.nome" placeholder="Digite o nome do projeto"
                        type="text">
                </div>
                <div class="linha">
                    <label>Descrição</label>
                    <textarea ng-model="projetoEditar.descricao" placeholder="Digite a descrição do projeto" cols="40"
                        rows="3"></textarea>
                </div>
                <div class="linha">
                    <button id="btCncPrj" class="btn btn-warning" ng-click="cancelarProjeto()">
                        <i class="glyphicon glyphicon-remove"></i>
                        Cancelar
                    </button>

                    <button id="btnSlvPrj" class="btn btn-primary" ng-click="gravarProjeto()">
                        <i class="glyphicon glyphicon-ok"></i>
                        Salvar</button>
                </div>
            </div>
        </dialog>

        <dialog id="dPo" class="dPrj">
            <div class="mPrj">
                <div class="linha">
                    <H1>Envolvido</H1>
                </div>
                <div class="linha">
                    <label>Nome</label>
                    <input maxlength="30" ng-model="poEditar.nome" placeholder="Digite o nome" type="text">
                </div>
                <div class="linha">
                    <label>Email</label>
                    <input maxlength="30" ng-model="poEditar.email" placeholder="Digite o email" type="text">
                </div>
                <div class="linha">
                    <label>Telefone</label>
                    <input maxlength="30" ng-model="poEditar.telefone" placeholder="Digite o telefone" type="text">
                </div>
                <div class="linha">
                    <button id="btCncPo" class="btn btn-warning" ng-click="cancelarPo()">
                        <i class="glyphicon glyphicon-remove"></i>
                        Cancelar</button>
                    <button id="btnSlvPo" class="btn btn-primary" ng-click="gravarPo()">
                        <i class="glyphicon glyphicon-ok"></i>
                        Salvar</button>
                </div>
            </div>
        </dialog>

        <dialog id="dTask" class="dPrj">
            <div class="mPrj">
                <div class="linha">
                    <H1>Tarefa</H1>
                </div>
                <div class="linha">
                    <label>Descrição da tarefa</label>
                    <input maxlength="30" type="text" id="txtDescTask" ng-model="taskEditar.descricao"
                        placeholder="Digite a tarefa">
                </div>
                <div class="linha">
                    <button id="btCncTask" class="btn btn-warning" ng-click="cancelarTask()">
                        <i class="glyphicon glyphicon-remove"></i>
                        Cancelar</button>
                    <button id="btnSlvTask" class="btn btn-primary" ng-click="gravarTask()">
                        <i class="glyphicon glyphicon-ok"></i>
                        Salvar</button>
                </div>
            </div>
        </dialog>

        <dialog id="dAtividade" class="dPrj">
            <div class="mPrj">
                <div class="linha">
                    <H1>Atividade</H1>
                </div>
                <div class="linha">
                    <label>Descrição da atividade</label>
                    <input class="form-control" ng-model="atividadeEditar.descricao"
                        placeholder="Digite a descrição da atividade" maxlength="60" type="text">
                </div>
                <div>
                    <label>Estimativa</label>
                    <br>
                    <div class="linha2">
                        <input class="inpt form-control" min="0" ng-model="atividadeEditar.hora" type="number"><label
                            class="pontos">:</label>
                        <input class="inpt form-control" step="5" min="0" max="59" ng-model="atividadeEditar.minuto"
                            type="number">

                    </div>
                </div>
                <div class="displayTime">
                    <label>{{ atividadeEditar.hora | zpad:1 }}:{{atividadeEditar.minuto | zpad:2}}</label>
                </div>
                <div class="linha">
                    <button id="btCncAtividade" class="btn btn-warning" ng-click="cancelarAtividade()">
                        <i class="glyphicon glyphicon-remove"></i>
                        Cancelar</button>
                    <button id="btnSlvAtividade" class="btn btn-primary" ng-click="gravarAtividade()">
                        <i class="glyphicon glyphicon-ok"></i>
                        Salvar</button>
                </div>
            </div>
        </dialog>

        <dialog id="dApontamento" class="dPrj">
            <div class="mPrj">
                <div class="linha">
                    <H1>Apontamento</H1>
                </div>
                <div class="linha">
                    <label>Data</label>
                    <input class="form-control" type="date" ng-model="apontamentoEditar.data">
                </div>
                <div>
                    <label>Tempo</label>
                    <br>
                    <div class="linha2">
                        <input class="input form-control" min="0" max="8" type="number"
                            ng-model="apontamentoEditar.hora"> <label class="pontos">:</label>
                        <input class="input form-control" min="0" step="5" max="59" type="number"
                            ng-model="apontamentoEditar.minuto">
                    </div>
                </div>
                <div class="displayTime">
                    <label>{{ apontamentoEditar.hora | zpad:1 }}:{{apontamentoEditar.minuto | zpad:2}}</label>
                </div>

                <div class="linha">
                    <label>Percentual atual da tarefa</label>
                    <input class="form-control" type="number" min="0" max="100" step="5"
                        ng-model="apontamentoEditar.percentual">
                </div>
                <div class="displayTime">
                    <label>{{apontamentoEditar.data | date:'dd/MM/yyyy'}} - {{ apontamentoEditar.hora | zpad:1
                        }}:{{apontamentoEditar.minuto
                        | zpad:2}} - {{apontamentoEditar.percentual}}%</label>
                </div>

                <div class="linha">
                    <button class="btn btn-warning" ng-click="cancelarApontamento()">
                        <i class="glyphicon glyphicon-remove"></i>
                        Cancelar
                    </button>
                    <button class="btn btn-primary" ng-click="gravarApontamento()">
                        <i class="glyphicon glyphicon-ok"></i>
                        Salvar
                    </button>
                </div>
            </div>
        </dialog>

        <dialog id="dSaida" class="dPrj">
            <div class="mPrj">

                <div class="linha">
                    <textarea ng-show="1===3" ng-model="txtSaida" cols="100" rows="15">

                    </textarea>
                    <div>
                        <p ng-bind-html="cnt"></p>
                    </div>


                    <div class="linha">
                        <button class="btn btn-warning" ng-click="fecharSaida()">
                            <i class="glyphicon glyphicon-remove"></i>
                            Cancelar
                        </button>
                        <button class="btn btn-primary" ng-click="salvarArquivo()">
                            <i class="glyphicon glyphicon-download-alt"></i>
                            Exportar
                        </button>
                    </div>


                </div>
            </div>
        </dialog>
    </div>
</body>
<script>
    angular.module('prjMngProjetos', ['ngSanitize'])
        .filter("reverse", function () {
            return function (items) {
                return items.slice().reverse(); // Create a copy of the array and reverse the order of the items
            };
        })
        .filter('zpad', function () {
            return function (input, n) {
                if (input === undefined)
                    input = '0'
                return String(input).padStart(n, '0');
            };
        })
        .controller('listProjetosController', function ($scope) {
            $scope.projetos = [];

            $scope.lerDadosStorage = function () {
                const dados = localStorage.getItem('mngPrj');

                if (dados) {
                    $scope.projetos = JSON.parse(dados);

                    $scope.projetos.forEach(projeto => {
                        projeto.visible = false;

                        projeto.tasks.forEach((task) => {
                            task.visible = false;

                            task.apontamentos.visible = false;
                            task.atividades.visible = false;
                        })
                    })
                }
            };

            $scope.gravarDadosStorage = function () {
                const dados = JSON.stringify($scope.projetos);

                localStorage.setItem('mngPrj', dados);
            };

            $scope.lerDadosStorage();

            $scope.transformaTempoEmInteiro = function (tempo) {
                var arrayTempo = String(tempo).split(':');

                var tempo_seg = ((parseInt(arrayTempo[0]) * 60) + parseInt(arrayTempo[1]));

                return tempo_seg;
            }

            $scope.somartempos = function (tempo1, tempo2) {

                if (tempo1 === "") {
                    tempo1 = "00:00";
                }

                var tempo_seg1 = $scope.transformaTempoEmInteiro(tempo1);

                var tempo_seg2 = $scope.transformaTempoEmInteiro(tempo2);

                var totalMinutos = tempo_seg1 + tempo_seg2

                var tempoDecimal = totalMinutos / 60;

                var horas = Math.floor(tempoDecimal);

                var minutosDecimal = tempoDecimal - horas;

                var minutos = Math.round(minutosDecimal * 60);

                return String(horas).padStart(2, '0') + ':' + String(minutos).padStart(2, '0');
            };

            $scope.estimativaGeral = function (projeto) {

                if (projeto.tasks.length > 0)

                    return projeto.tasks.map(tks => {
                        return tks.atividades.map(x => x.hora + ':' + x.minuto).reduce((p, c) => {
                            return $scope.somartempos(p, c)
                        }, '00:00')
                    }).reduce((p, c) => {
                        return $scope.somartempos(p, c)
                    }, '00:00');
                else
                    return '00:00';
            };

            $scope.apontamentosGeral = (projeto) => {

                if (projeto.tasks.length > 0) {

                    return projeto.tasks.map(tks => {
                        return tks.apontamentos.map(x => x.hora + ':' + x.minuto).reduce((p, c) => {
                            return $scope.somartempos(p, c)
                        }, '00:00')
                    }).reduce((p, c) => {
                        return $scope.somartempos(p, c)
                    }, '00:00');
                } else {
                    return '00:00';
                }
            };

            $scope.estimativaTarefa = (tarefa) => {
                return tarefa.atividades
                    .map(x => x.hora + ':' + x.minuto)
                    .reduce((p, c) => {
                        return $scope.somartempos(p, c)
                    }, '00:00');
            };

            $scope.apontamentosTarefa = (tarefa) => {
                return tarefa.apontamentos
                    .map(x => x.hora + ':' + x.minuto)
                    .reduce((p, c) => {
                        return $scope.somartempos(p, c)
                    }, '00:00');
            }

            $scope.restanteTarefa = (tarefa) => {
                let percentual = 0;

                if (tarefa.apontamentos.slice(-1).length > 0) {
                    percentual = tarefa.apontamentos.slice(-1)[0].percentual;
                }

                const totEstimativas = $scope.estimativaTarefa(tarefa);

                const totApontado = $scope.apontamentosTarefa(tarefa);

                let restante = totEstimativas;

                if (percentual > 0) {
                    restante = calcularRestante(totApontado, percentual);
                }
                return restante;
            };

            const calcularRestante = (totApontado, percentual) => {

                if (totApontado === "") {
                    totApontado = "00:00";
                }

                var tempo_seg1 = $scope.transformaTempoEmInteiro(totApontado);

                var valor = tempo_seg1 / (percentual / 100);

                var tempoDecimal = valor / 60;

                var horas = Math.floor(tempoDecimal);

                var minutosDecimal = tempoDecimal - horas;

                var minutos = Math.round(minutosDecimal * 60);

                return String(horas).padStart(2, '0') + ':' + String(minutos).padStart(2, '0');
            };

            $scope.qtdProjetos = [];

            $scope.abrirDiaolgProjeto = (projeto1) => {

                $scope.qtdProjetos = [];

                for (let i = 0; i <= $scope.projetos.length; i++) {
                    $scope.qtdProjetos.push(i + 1);
                }

                $scope.projetoSel = projeto1;

                $scope.projetoEditar = angular.copy(projeto1);

                dProjeto.show();

            };

            $scope.gravarProjeto = () => {

                if ($scope.projetoEditar === undefined) {
                    alert('Informe os dados');
                    return;
                }

                if ($scope.projetoEditar.nome === undefined) {
                    alert('Informe o nome do projeto');
                    return false;
                }
                else if ($scope.projetoEditar.nome.length < 5) {
                    alert('O nome do projeto deve ter no minimo 5 caracteres');
                    return;
                }

                if ($scope.projetoEditar.descricao === undefined) {
                    alert('Informe a descrição do projeto');
                    return false;
                }
                else if ($scope.projetoEditar.descricao.length < 20) {
                    alert('A descrição do projeto deve ter no minimo 20 caracteres');
                    return;
                }

                if ($scope.projetoSel) {
                    angular.extend($scope.projetoSel, $scope.projetoEditar);
                }
                else {
                    $scope.projetoEditar.tasks = [];
                    $scope.projetoEditar.pos = [];
                    $scope.projetoEditar.id = generateUUID();


                    $scope.projetos.push($scope.projetoEditar);
                }

                $scope.projetoEditar = {};

                $scope.gravarDadosStorage();
                $scope.qtdProjetos = [];
                dProjeto.close();
                $scope.lerDadosStorage();
            };

            $scope.cancelarProjeto = () => {
                $scope.qtdProjetos = [];
                $scope.projetoEditar = {};
                dProjeto.close();
            };

            $scope.deleteProjeto = (projeto) => {
                if (confirm('Deseja excluir o projeto?')) {

                    $scope.projetos = $scope.projetos.filter((cc) => cc != projeto);
                    $scope.gravarDadosStorage();
                }
            }

            $scope.fecharSaida = () => {
                $scope.txtSaida = null;
                dSaida.close();
            }

            $scope.exportarProjeto = (projeto) => {

                let oi = ''

                const ulPrj = document.createElement('UL');
                ulPrj.classList = 'projetos';

                const lblPrj = document.createElement('LABEL');
                lblPrj.textContent = 'projeto - ' + projeto.nome;

                ulPrj.appendChild(lblPrj);

                const li1 = document.createElement('LI');


                const preDesc = document.createElement('p');
                preDesc.textContent ="Descrição: " + projeto.descricao;

                li1.appendChild(lblPrj);
                li1.appendChild(preDesc);

                const li2 = document.createElement('LI');
                li2.setAttribute('display','grid');
                li2.innerHTML = "<label>Envolvidos(" + projeto.pos.length + ')</label>';

                const ulPo = document.createElement('TABLE');
                   
                const trPo = document.createElement('TR');

                trPo.innerHTML = '<th>Nome</th><th>E-mail</th><th>Telefone</th>';

                ulPo.appendChild(trPo);

                projeto.pos.forEach(po => {
                    const liPo = document.createElement('TR');
                        
                    liPo.innerHTML =  '<TD>'+po.nome + '</TD><TD>' + po.email + '</TD><TD>' + po.telefone+'</TD>';
                    ulPo.appendChild(liPo);
                })

                li2.appendChild(ulPo);

                const li3 = document.createElement('LI');
                li3.innerHTML = '<label>Tarefas(' + projeto.tasks.length +
                    ') - Estimado: ' + $scope.estimativaGeral(projeto) +
                    ', Apontamentos: ' + $scope.apontamentosGeral(projeto) +
                    ' - Total Real ' + $scope.restanteGeral(projeto) + '</label>';

                const ulTarefas = document.createElement('TABLE');


                ulTarefas.innerHTML = '<TR><th>Tarefa</th><th>Estimado</th><th>Apontamentos</th><th>Concluído</th><th>Real esperado</th></TR>';


                projeto.tasks.forEach(tarefa => {
                    let percentual = 0;

                    if (tarefa.apontamentos.length) {
                        percentual = tarefa.apontamentos.slice(-1)[0].percentual;
                    }

                    const liAtividades = document.createElement('TR');

                    liAtividades.innerHTML = '<td>' + tarefa.descricao +
                        '</td><td>' + $scope.estimativaTarefa(tarefa) +
                        '</td><td>' + $scope.apontamentosTarefa(tarefa) +
                        '</td><td>' + percentual + '%' +
                        '</td><td>' + $scope.restanteTarefa(tarefa) + '</td>';


                    ulTarefas.appendChild(liAtividades);

                });



                li3.appendChild(ulTarefas);


                ulPrj.appendChild(li1);
                ulPrj.appendChild(li2);
                ulPrj.appendChild(li3);

                const divGeral = document.createElement('DIV');
                divGeral.appendChild(ulPrj);

                $scope.cnt = divGeral.innerHTML;
                dSaida.show();
          
            }

            $scope.salvarArquivo = () => {


                //salvar('projeto', $scope.txtSaida);

                const data = new Date();




                let txtHtml = '<html><head>'+
                    '<style> '+
                        '*{    font-size: x-large;}'+
                        'li{margin-left: 20px; display: grid; padding: 10px;} '+
                        'table {border: 1px solid; padding: 5px; margin-left: 20px;font-size: smaller; margin-top: 10px}'+
                        'td{ border-bottom: 1px solid; border-right: 1px solid;}'+
                        'label{font-weight: bolder;} '+
                        'th{font-weight: bolder; border: 1px solid; background: black;color: beige} '+
                        '</style>'+
                    
                    '</head><body><div>Report: ' + data.toLocaleString() +'</div>'+
                        $scope.cnt + 
                    '</body></html>';

                salvar('projeto', txtHtml);

            }

            $scope.abrirDiaolgPo = (projeto, po) => {
                $scope.projetoAtual = projeto;

                if (po) {

                    $scope.poSel = po;

                    $scope.poEditar = angular.copy(po);
                }
                dPo.show();
            };

            $scope.cancelarPo = () => {
                $scope.poEditar = {};
                dPo.close();
            };

            $scope.gravarPo = () => {

                if ($scope.poEditar === undefined) {
                    alert('Informe os dados');
                    return;
                }

                if ($scope.poEditar.nome === undefined) {
                    alert('Informe o nome do envolvida');
                    return false;
                }
                else if ($scope.poEditar.nome.length < 5) {
                    alert('O nome do envolvido deve ter no minimo 5 caracteres');
                    return;
                }

                if ($scope.poEditar.email != undefined) {
                    if ($scope.poEditar.email.length < 10) {
                        alert('O e-mail do envolvido deve ter no minimo 10 caracteres');
                        return;
                    }
                }

                if ($scope.poEditar.telefone != undefined) {
                    if ($scope.poEditar.telefone.length < 8) {
                        alert('O telefone do envolvido deve ter no minimo 8 caracteres');
                        return;
                    }
                }


                if ($scope.poSel) {
                    angular.extend($scope.poSel, $scope.poEditar);
                }
                else {
                    $scope.projetoAtual.pos.push($scope.poEditar);
                }

                $scope.poEditar = {};

                delete $scope.projetoAtual;

                $scope.gravarDadosStorage();

                dPo.close();
            };

            $scope.deletePo = (projeto, po) => {
                if (confirm('Deseja excluir o envolvido?')) {

                    projeto.pos = projeto.pos.filter((cc) => cc != po);
                    $scope.gravarDadosStorage();
                }
            }

            $scope.abrirDiaolgTask = (projeto, task) => {
                $scope.projetoAtual = projeto;

                $scope.taskSel = task;

                if (task) {

                    $scope.taskEditar = angular.copy(task);
                }
                dTask.show();
            };

            $scope.cancelarTask = () => {
                $scope.taskEditar = {};
                dTask.close();
            };

            $scope.gravarTask = () => {

                if ($scope.taskEditar === undefined) {
                    alert('Informe os dados');
                    return;
                }

                if ($scope.taskEditar.descricao === undefined) {
                    alert('Informe a descrição da tarefa');
                    return false;
                }
                else if ($scope.taskEditar.descricao.length < 10) {
                    alert('OA descrição da tarefa deve ter no minimo 10 caracteres');
                    return;
                }

                if ($scope.taskSel) {
                    angular.extend($scope.taskSel, $scope.taskEditar);
                }
                else {
                    $scope.taskEditar.atividades = [];
                    $scope.taskEditar.apontamentos = [];
                    $scope.projetoAtual.tasks.push($scope.taskEditar);
                }

                $scope.taskEditar = {};

                delete $scope.projetoAtual;

                $scope.gravarDadosStorage();

                dTask.close();
            };

            $scope.deleteTask = (projeto, task) => {
                if (confirm('Deseja excluir a tarefa?')) {

                    projeto.tasks = projeto.tasks.filter((cc) => cc != task);
                    $scope.gravarDadosStorage();
                }
            }

            $scope.abrirDialogAtividade = (task, atividade) => {
                $scope.taskSel = task;

                $scope.atividadekSel = atividade;

                if (atividade) {

                    $scope.atividadeEditar = angular.copy(atividade);
                }
                dAtividade.show();
            };

            $scope.cancelarAtividade = () => {
                $scope.atividadeEditar = {};
                $scope.atividadekSel = [];
                dAtividade.close();
            };

            $scope.gravarAtividade = () => {

                if ($scope.atividadeEditar === undefined) {
                    alert('Informe os dados');
                    return;
                }

                if ($scope.atividadeEditar.descricao === undefined) {
                    alert('Informe a descrição da atividade');
                    return false;
                }
                else if ($scope.atividadeEditar.descricao.length < 10) {
                    alert('OA descrição da atividade deve ter no minimo 10 caracteres');
                    return;
                }

                if ($scope.atividadeEditar.hora === undefined) {
                    alert('Informe hora');
                    return false;
                }

                if ($scope.atividadeEditar.minuto === undefined) {
                    alert('Informe os minutos');
                    return false;
                }
                else {
                    if ($scope.atividadeEditar.minuto > 59) {
                        alert('O valor maximo para minutos é 59');
                        return false;
                    }
                }

                if ($scope.atividadekSel) {
                    angular.extend($scope.atividadekSel, $scope.atividadeEditar);
                }
                else {
                    $scope.taskSel.atividades.push($scope.atividadeEditar);
                }

                $scope.atividadeEditar = {};

                $scope.gravarDadosStorage();

                dAtividade.close();
            };

            $scope.deleteAtividade = (tarefa, atividade) => {
                if (confirm('Deseja excluir a atividade?')) {

                    tarefa.atividades = tarefa.atividades.filter((x) => x != atividade);

                    $scope.gravarDadosStorage();
                }
            };

            $scope.abrirDialogApontamento = (task, apontamento) => {

                $scope.taskSel = task;

                $scope.aapontamentoSel = apontamento;

                if (apontamento) {

                    $scope.apontamentoEditar = angular.copy(apontamento);
                }
                else {
                    //$scope.apontamentoEditar.hora ={ value:20} ;
                }
                dApontamento.show();
                console.log($scope.apontamentoEditar);
            };

            $scope.cancelarApontamento = () => {
                $scope.apontamentoEditar = {};
                $scope.apontamentokSel = [];
                dApontamento.close();
            };

            $scope.gravarApontamento = () => {


                if ($scope.apontamentoEditar === undefined) {
                    alert('Informe os dados');
                    return;
                }
                else {
                    if ($scope.apontamentoEditar.data === undefined) {
                        alert('Informe a data');
                        return;
                    }

                    if ($scope.apontamentoEditar.hora === undefined) {
                        alert('Informe a hora');
                        return;
                    }
                    if ($scope.apontamentoEditar.minuto === undefined) {
                        alert('Informe os minutos')
                        return;
                    }
                    if ($scope.apontamentoEditar.percentual === undefined) {
                        alert('Infomre o percentual atual da tarefa');
                        return;
                    }
                }

                let data = String($scope.apontamentoEditar.data).split('-');

                let dt = new Date(data[0], data[1] - 1, data[2]);

                $scope.apontamentoEditar.data = dt.toLocaleDateString();

                console.log($scope.apontamentoEditar);

                if ($scope.apontamentoSel) {
                    angular.extend($scope.apontamentoSel, $scope.apontamentoEditar);
                }
                else {
                    $scope.taskSel.apontamentos.push($scope.apontamentoEditar);
                }

                $scope.apontamentoEditar = {};

                $scope.gravarDadosStorage();

                dApontamento.close();
            };

            $scope.deleteApontamento = (tarefa, apontamento) => {
                if (confirm('Deseja excluir o apontamento?')) {

                    tarefa.apontamentos = tarefa.apontamentos.filter((x) => x != apontamento);

                    $scope.gravarDadosStorage();
                }
            };

            $scope.restanteGeral = (projeto) => {

                let cc = "00:00";

                projeto.tasks.forEach((tarefa) =>
                    cc = $scope.somartempos(cc, $scope.restanteTarefa(tarefa))
                )
                return cc;
            }

            $scope.primeiroPrj = (projeto) => {
                if ($scope.projetos.length === 1) {
                    return projeto.pos.length > 0 || projeto.tasks.length > 0;
                }
                return true;
            }

        });

</script>
</body>

</html>